<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Heart Rate from Bangle.js</title>
</head>
<body>
    <!-- Connect Button -->
  <button id="btnConnect">Connect</button>

  <!-- Heart Rate Display -->
  <h1>Heart Rate Data</h1>
  <p id="heartRateDisplay">Waiting for data...</p>
  
  <script src="https://www.puck-js.com/puck.js"></script>
  <script>
    
    var currentBPM = null;
    var currentConfidence = null;

    var BANGLE_CODE = `
     Bangle.on('step', function(count) {
      Bluetooth.println('S,' + count); // Send step count via Bluetooth
      });
      var temp = E.getTemperature(); temp = 'T'+temp; console.log(temp);
      var battery = E.getBattery(); battery = 'B'+battery; console.log(battery);
      Bangle.setGPSPower(1);
      Bangle.on('GPS', function(location) {
      console.log("Latitude: " + location.lat + ", Longitude: " + location.lon);
      });

      
      Bangle.setHRMPower(1);
      Bangle.on('HRM', function(hrm) {
        var d = [
          "H",
          hrm.bpm,
          hrm.confidence
        ];
        Bluetooth.println(d.join(","));
      });
      // Accelerometer setup
      Bangle.on('accel', function(a) {
        var dA = [
          "A",
          a.x.toFixed(2),
          a.y.toFixed(2),
          a.z.toFixed(2)
        ];
        Bluetooth.println(dA.join(","));
        console.log("Accel"+dA);
      });
    `;

    var connection;
    
    document.getElementById("btnConnect").addEventListener("click", function() {
      // disconnect if connected already
      if (connection) {
        connection.close();
        connection = undefined;
      }
      
      // Connect
      Puck.connect(function(c) {
        if (!c) {
          alert("Couldn't connect!");
          return;
        }
        connection = c;

        // Handle incoming data
        var buf = "";
        connection.on("data", function(d) {
          buf += d;
          var lines = buf.split("\n");
          buf = lines.pop(); // Keep the last incomplete line in buffer
          lines.forEach(onLine); // Process each complete line
        });

        // First, reset the Bangle
        connection.write("reset();\n", function() {
          // Wait for it to reset
          setTimeout(function() {
            // Now upload our code to monitor heart rate
            connection.write("\x03\x10if(1){" + BANGLE_CODE + "}\n",
              function() { console.log("Ready to monitor heart rate."); });
          }, 1500);
        });
      });
    });

    // Function to process each line of heart rate data
    // Write code to split the value of Temperature, battery , Accelerometer
    function onLine(line) {
      console.log("Received: " + line);
      var parts = line.split(",");
      if (parts[0] === "H") {
        currentBPM = parts[1];
        currentConfidence = parts[2];
        setinterval(
        document.getElementById("heartRateDisplay").textContent = 
          "Heart Rate: " + currentBPM + " BPM, Confidence: " + currentConfidence;,3000);
      }
    }

  </script>



</body>
</html>
