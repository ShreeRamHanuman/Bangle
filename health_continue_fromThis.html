<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Heart Rate from Bangle.js</title>
</head>
<body>
    <!-- Connect Button -->
  <button id="btnConnect">Connect</button>

  <!-- Heart Rate Display -->
  <h1>Heart Rate Data</h1>
  <p id="heartRateDisplay">Waiting for data...</p>

  <!-- Acceleration Rate Display -->
  <h1>Acceleration Data Display</h1>
  <p id="accelerationDataDisplay">Waiting for data...</p>

  <!-- Temperature Rate Display -->
  <h1>Temperature Data Display</h1>
  <p id="temperatureDataDisplay">Waiting for data...</p>

  <!-- Battery Rate Display -->
  <h1>Battery Data Display</h1>
  <p id="batteryDataDisplay">Waiting for data...</p>

    <!-- Steps Rate Display -->
    <h1>Steps Data Display</h1>
    <p id="stepDataDisplay">Waiting for data...</p>
  
  <script src="https://www.puck-js.com/puck.js"></script>
  <script>
    
    var currentBPM = null;
    var currentConfidence = null;
    var currentTemperature = null;
    var currentBattery = null;
    var currentAccel1 = null;
    var currentAccel2 = null;
    var currentAccel3 = null;
    var currentStep = null;

    
    var connection;
     var lastDataTime = 0; // Variable to track the last time data was processed
    var intervalTime = 30000; // 30 seconds in milliseconds

    var BANGLE_CODE = `
     setInterval( function() {Bangle.on('step', function(count) {
      Bluetooth.println('S,' + count); // Send step count via Bluetooth
      });}, 3000); // every 3 second -- change this to 30 second
      setInterval( function() { var temp = E.getTemperature(); temp = 'T,'+temp; console.log(temp);
      Bluetooth.println(temp); }, 3000);

     setInterval( function() { var battery = E.getBattery(); battery = 'B,'+battery; console.log(battery);
      Bluetooth.println(battery);}, 3000);

      Bangle.setGPSPower(1);
      Bangle.on('GPS', function(location) {
      console.log("Latitude: " + location.lat + ", Longitude: " + location.lon);

      Bluetooth.println('L,'+ location.lat +','+ location.lon);
      });

      
      Bangle.setHRMPower(1);
      Bangle.on('HRM', function(hrm) {
        var d = [
          "H",
          hrm.bpm,
          hrm.confidence
        ];
        Bluetooth.println(d.join(","));
      });
      // Accelerometer setup
      Bangle.on('accel', function(a) {
        var dA = [
          "A",
          a.x.toFixed(2),
          a.y.toFixed(2),
          a.z.toFixed(2)
        ];
        Bluetooth.println(dA.join(","));
        console.log("Accel"+dA);
      });
    `;

    
    document.getElementById("btnConnect").addEventListener("click", function() {
      // disconnect if connected already
      if (connection) {
        connection.close();
        connection = undefined;
      }
      
      // Connect
      Puck.connect(function(c) {
        if (!c) {
          alert("Couldn't connect!");
          return;
        }
        connection = c;

        // Handle incoming data
        var buf = "";
        connection.on("data", function(d) {
          buf += d;
          var lines = buf.split("\n");
          buf = lines.pop(); // Keep the last incomplete line in buffer
          lines.forEach(onLine); // Process each complete line
        });

        // First, reset the Bangle
        connection.write("reset();\n", function() {
          // Wait for it to reset
          setTimeout(function() {
            // Now upload our code to monitor heart rate
            connection.write("\x03\x10if(1){" + BANGLE_CODE + "}\n",
              function() { console.log("Ready to monitor heart rate."); });
          }, 1500);
        });
      });
    });

    // Function to process each line of heart rate data
    // Write code to split the value of Temperature, battery , Accelerometer
    function onLine(line) {
      console.log("Received: " + line);
      var parts = line.split(",");
      if (parts[0] === "H") {
        currentBPM = parts[1];
        currentConfidence = parts[2];
 // Process heart rate data only every 30 seconds
        var currentTime = Date.now();
        if (currentTime - lastDataTime >= intervalTime) {
          lastDataTime = currentTime; // Update last data time
        document.getElementById("heartRateDisplay").textContent = 
          "Heart Rate: " + currentBPM + " BPM, Confidence: " + currentConfidence;
        }
      }
    }

  </script>



</body>
</html>
