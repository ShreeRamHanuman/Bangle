<html>
<head>
  <title>Heart Rate from Bangle.js</title>
</head>
<body>
  <script src="https://www.espruino.com/js/uart.js"></script>
  <script>
    
var currentBPM = null;
var currentConfidence = null;

     var BANGLE_CODE = `
  Bangle.setHRMPower(1)
  Bangle.on('HRM',function(hrm) {
    var d = [
      "H",
      hrm.bpm,
      hrm.confidence
      ];
    Bluetooth.println(d.join(","));
  })
  `;
var connection;
  document.getElementById("btnConnect").addEventListener("click", function() {
    // disconnect if connected already
    if (connection) {
      connection.close();
      connection = undefined;
    }
    // Connect
    UART.eval(function(c) {
      if (!c) {
        alert("Couldn't connect!");
        return;
      }
      connection = c;
      // Handle the data we get back, and call 'onLine'
      // whenever we get a line
      var buf = "";
      connection.on("data", function(d) {
        buf += d;
        var l = buf.split("\n");
        buf = l.pop();
        l.forEach(onLine);
      });
      // First, reset the Bangle
      connection.write("reset();\n", function() {
        // Wait for it to reset itself
        setTimeout(function() {
          // Now upload our code to it
          UART.write("\x03\x10if(1){"+BANGLE_CODE+"}\n",
            function() { console.log("Ready..."); });
        }, 1500);
      });
    });
  });


  </script>

  <h1>Health Status 109</h1><button onclick="getHealthHeart()">Get Heart Rate</button>
</body>
</html>
